name: Deploy Functions

on:
    push:
        branches: main
        paths:
            - 'functions/**'
            - 'firebase.*'
            - '.github/workflows/functions-deploy.yml'

jobs:
    build:
        uses: ./.github/workflows/functions-build.yml

    deploy:
        name: Deploy functions
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
            - name: Use Node v16
              uses: actions/setup-node@v3
              with:
                  node-version-file: 'functions/.nvmrc'
            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ^8.6.9
            - name: Install dependencies
              run: pnpm -C ./functions/ install
            - name: Download Artifact
              uses: actions/download-artifact@v3
              with:
                  name: functions-build
                  path: build
            - name: Get commit message
              run: |
                  MSG="${{ github.event.head_commit.message }}"
                  echo "commit_msg=${MSG%%$'\n'*}" >> "$GITHUB_ENV"
            - name: Deploy functions
              uses: w9jds/firebase-action@master
              with:
                  args: deploy --only functions --message \"${{ env.commit_msg }}\"
              env:
                  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
                  PROJECT_ID: ben-keys-spotify-tools
